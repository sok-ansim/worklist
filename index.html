<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê²€ì‚¬ Worklist</title>
  <style>
    body { font-size: 22px; text-align: center; font-family: Arial, sans-serif; }
    input, select, button { font-size: 22px; padding: 6px 10px; margin: 5px; }
    table { margin: 20px auto; border-collapse: collapse; font-size: 22px; width: 95%; max-width: 1200px; }
    th, td { padding: 10px 14px; text-align: center; }
    th { background: #f0f0f0; }
    .groupRow td { background: #fafafa; font-weight: 700; text-align: left; }
    .small { font-size: 18px; }
    .muted { color: #666; }
    .box { display: inline-block; padding: 8px 14px; border: 1px solid #ddd; border-radius: 10px; }
    .row { margin: 6px 0; }
    .search { width: 220px; }
    .short { width: 140px; } /* âœ… ì´ë¦„/ì°¨íŠ¸ë²ˆí˜¸ ì¹¸ ì¤„ì´ê¸° */
  </style>
</head>
<body>
  <h2>í™˜ì ë“±ë¡</h2>

  <div class="box">
    <div class="row">
      ê²€ì‚¬ë‚ ì§œ: <input id="examDate" type="date" />
      ì´ë¦„: <input id="name" class="short" />
      ì°¨íŠ¸ë²ˆí˜¸: <input id="chart" class="short" />
        ê²€ì‚¬í•­ëª©:
      <select id="exam">
        <option value="C-CT">C-CT</option>
        <option value="A-CT">A-CT</option>
        <option value="B-CT">B-CT</option>
        <option value="CTA">CTA</option>
        <option value="CECA">CECA</option>
        <option value="KDCT">KDCT</option>
        <option value="PDCT">PDCT</option>
        <option value="ADCT">ADCT</option>
        <option value="B-MRI">B-MRI</option>
        <option value="B-MRA">B-MRA</option>
        <option value="B-MRI&MRA">B-MRI&MRA</option>
        <option value="ë³µë¶€MRI">ë³µë¶€MRI</option>
        <option value="SPINE-MRI">SPINE-MRI</option>
        <option value="ê´€ì ˆMRI">ê´€ì ˆMRI</option>
      </select>
      <button id="btnAdd">ë“±ë¡</button>
    </div>

    <div class="row">
      ì°¾ê¸°:
      <input id="q" class="search" placeholder="ì´ë¦„/ì°¨íŠ¸/ê²€ì‚¬" />
      <button id="btnSearch">ê²€ìƒ‰</button>
      <button id="btnReset">ì´ˆê¸°í™”</button>
    </div>
  </div>

  <hr />

  <h2>Worklist</h2>

  <table border="1">
    <thead>
      <tr>
        <th>ê²€ì‚¬ë‚ ì§œ</th>
        <th>ì´ë¦„</th>
        <th>ì°¨íŠ¸ë²ˆí˜¸</th>
        <th>ê²€ì‚¬í•­ëª©</th>
        <th>ìƒíƒœ</th>
        <th>ë‚´ì›ì‹œê°„</th>
        <th>Start</th>
        <th>Finish</th>
        <th>ë‚´ì›</th>
        <th>ì‚­ì œ</th>
      </tr>
    </thead>
    <tbody id="list"></tbody>
  </table>

  <script>
    const STORAGE_KEY = "worklist_v4";

    function pad2(n){ return String(n).padStart(2, "0"); }
    function todayStr(){
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }
    function timeOnly(d){
      return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
    }

    let items = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(items)); }

    function pruneOlderThan7Days(){
      const now = new Date();
      const cutoff = new Date(now);
      cutoff.setDate(cutoff.getDate() - 6);
      cutoff.setHours(0,0,0,0);
      items = items.filter(it => new Date(it.examDate + "T00:00:00") >= cutoff);
      save();
    }

    function addItem(){
      const name = document.getElementById("name").value.trim();
      const chart = document.getElementById("chart").value.trim();
      const exam = document.getElementById("exam").value;
      const examDate = document.getElementById("examDate").value;

      if(!name || !chart) return alert("ì´ë¦„ê³¼ ì°¨íŠ¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
      if(!examDate) return alert("ê²€ì‚¬ë‚ ì§œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.");

      const now = new Date();
      items.push({
        id: crypto.randomUUID ? crypto.randomUUID() : String(now.getTime()) + Math.random(),
        name, chart, exam, examDate,
        status: "ëŒ€ê¸°",
        visitAt: "",
        startAt: "",
        finishAt: "",
        createdAt: now.getTime()
      });

      save();
      pruneOlderThan7Days();
      render();

      document.getElementById("name").value = "";
      document.getElementById("chart").value = "";
    }

    function markVisit(id){
      const it = items.find(x => x.id === id);
      if(!it) return;
      if(!it.visitAt) it.visitAt = timeOnly(new Date());
      if(it.status === "ëŒ€ê¸°") it.status = "ë‚´ì›";
      save(); render();
    }

    function startExam(id){
      const it = items.find(x => x.id === id);
      if(!it) return;
      if(!it.visitAt) return alert("ë‚´ì› ë¨¼ì € ëˆŒëŸ¬ ì£¼ì„¸ìš”.");
      if(it.status !== "ë‚´ì›") return alert("ë‚´ì› ìƒíƒœì—ì„œë§Œ Start ê°€ëŠ¥");
      it.status = "ì§„í–‰ì¤‘";
      it.startAt = timeOnly(new Date());
      save(); render();
    }

    function finishExam(id){
      const it = items.find(x => x.id === id);
      if(!it) return;
      if(it.status !== "ì§„í–‰ì¤‘") return alert("ì§„í–‰ì¤‘ ìƒíƒœì—ì„œë§Œ Finish ê°€ëŠ¥");
      it.status = "ì™„ë£Œ";
      it.finishAt = timeOnly(new Date());
      save(); render();
    }

    function removeItem(id){
      if(!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
      items = items.filter(x => x.id !== id);
      save(); render();
    }

    function getQuery(){
      return (document.getElementById("q").value || "").trim().toLowerCase();
    }
    function matchQuery(it, q){
      if(!q) return true;
      const hay = `${it.name} ${it.chart} ${it.exam}`.toLowerCase();
      return hay.includes(q);
    }

    function resetSearch(){
      document.getElementById("q").value = "";
      render();
    }

    function render(){
      pruneOlderThan7Days();
      const q = getQuery();
      const list = document.getElementById("list");
      list.innerHTML = "";

      const filtered = items
        .filter(it => matchQuery(it, q))
        .sort((a,b) => {
          if(a.examDate !== b.examDate) return a.examDate < b.examDate ? 1 : -1;
          return (b.createdAt || 0) - (a.createdAt || 0);
        });

      const groups = new Map();
      for(const it of filtered){
        if(!groups.has(it.examDate)) groups.set(it.examDate, []);
        groups.get(it.examDate).push(it);
      }
      const dates = Array.from(groups.keys()).sort((a,b) => a < b ? 1 : -1);

      for(const d of dates){
        const trG = document.createElement("tr");
        trG.className = "groupRow";
        trG.innerHTML = `<td colspan="10">ğŸ“… ${d}</td>`;
        list.appendChild(trG);

        for(const it of groups.get(d)){
          const startDisabled = it.status !== "ë‚´ì›" ? "disabled" : "";
          const finishDisabled = it.status !== "ì§„í–‰ì¤‘" ? "disabled" : "";

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${it.examDate}</td>
            <td>${it.name}</td>
            <td>${it.chart}</td>
            <td>${it.exam}</td>
            <td>${it.status}</td>
            <td>${it.visitAt || "-"}</td>
            <td>${it.startAt || "-"}<br/><button ${startDisabled} onclick="startExam('${it.id}')">Start</button></td>
            <td>${it.finishAt || "-"}<br/><button ${finishDisabled} onclick="finishExam('${it.id}')">Finish</button></td>
            <td><button onclick="markVisit('${it.id}')">ë‚´ì›</button></td>
            <td><button onclick="removeItem('${it.id}')">ì‚­ì œ</button></td>
          `;
          list.appendChild(tr);
        }
      }

      if(filtered.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="10" class="muted">í‘œì‹œí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td>`;
        list.appendChild(tr);
      }
    }

    document.getElementById("btnAdd").addEventListener("click", addItem);
    document.getElementById("btnSearch").addEventListener("click", render);
    document.getElementById("btnReset").addEventListener("click", resetSearch);

    // âœ… ê²€ì‚¬ë‚ ì§œ ê¸°ë³¸ê°’: ì˜¤ëŠ˜
    document.getElementById("examDate").value = todayStr();

    // ì—”í„°ë¡œ ë“±ë¡/ê²€ìƒ‰
    document.getElementById("q").addEventListener("keydown", (e)=>{ if(e.key==="Enter") render(); });
    document.getElementById("name").addEventListener("keydown", (e)=>{ if(e.key==="Enter") addItem(); });
    document.getElementById("chart").addEventListener("keydown", (e)=>{ if(e.key==="Enter") addItem(); });

    render();
  </script>
</body>
</html>
